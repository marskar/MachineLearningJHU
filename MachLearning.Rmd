---
title: "MachLearnProj"
author: "Martin Skarzynski"
date: "January 6, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Practical Machine Learning Course Project

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

##Obtain Data
```{r}
## Download data
url_train <- "https://d396qusza40orc.cloudfront.net/predmachlearn/pml-training.csv"
dat_train <- "pml-training.csv"
download.file(url=url_train, destfile=dat_train, method = "auto")
url_test <- "https://d396qusza40orc.cloudfront.net/predmachlearn/pml-testing.csv"
dat_test <- "pml-testing.csv"
download.file(url=url_test, destfile=dat_test, method = "auto")
getwd()
## Import data and convert empty values to NA.
df_train <- read.csv(dat_train, na.strings=c("NA",""), header=TRUE)
colnames_train <- colnames(df_train)
df_test <- read.csv(dat_test, na.strings=c("NA",""), header=TRUE)
colnames_test <- colnames(df_test)
```

## Data Transformation: Remove NAs and IDs
```{r}
## Check number and percentage of NAs in test set
colSums(!is.na(df_test))
colMeans(is.na(df_test))*100
## Remove columns with only NAs in test set
df_testNoNA <- df_test[, colSums(is.na(df_test)) != nrow(df_test)]
df_trainSub <- df_train[, colSums(is.na(df_test)) != nrow(df_test)]
## We are left with two datasets that have 60 variables, instead of 160.
dim(df_testNoNA)
dim(df_trainSub)
## Check to see that colnames are the same in the two new datasets
colnames_trainSub <- colnames(df_trainSub)
colnames_testNoNA <- colnames(df_testNoNA)
setdiff(colnames_testNoNA,colnames_trainSub)
setdiff(colnames_trainSub,colnames_testNoNA)
## remove id columns from the new datasets
df_testTrim<- df_testNoNA[,c(-1, -60)]
df_trainTrim<- df_trainSub[,-1]
## No need to impute missing values, because there are no NAs in new training set
```
##Data Splitting
```{r}
## Data Partitioning: 65% for training and 35% for test 
set.seed(54321)
library(caret)
TrainSub <- createDataPartition(y=df_trainTrim$classe, p=0.65, list=FALSE)
myTraining <- df_trainTrim[TrainSub, ]
myTesting <- df_trainTrim[-TrainSub, ]
dim(myTraining)
dim(myTesting)
```
## Check for near zero variables
nsv<- nearZeroVar(df_trainTrim, saveMetrics = TRUE)
nsv
## Check to see which variables are highly correlated
M <- abs(cor(df_trainTrim[,c(-1,-4,-5,-59)]))
diag(M) <- 0
which(M>0.8, arr.ind = T)
## Principle Component Analysis
```{r}
## Use caret package to perform principle component analysis
preProc <- preProcess(df_trainTrim[,c(-1,-4,-5,-59)], method = "pca", pcaComp = 2)
PC<-predict(preProc,df_trainTrim[,c(-1,-4,-5,-59)])
plot(PC[,1],PC[,2], col=df_trainTrim$classe)
plot(PC[,1],PC[,2], col=df_trainTrim$user_name)
```
## Machine Learning
```{r}
## Use Decision Tree
modFit1 <- rpart(classe ~ ., data=myTraining, method="class")
predictions1 <- predict(modFit1, myTesting, type = "class")
confusionMatrix(predictions1, myTesting$classe)
##Use Random Forest
modFit2 <- randomForest(classe ~. , data=myTraining)
predictions2 <- predict(modFit2, myTesting, type = "class")
confusionMatrix(predictions2, myTesting$classe)
```
## Generate files for Quiz
```{r}
predictions3 <- predict(modFit2, myTesting, type = "class")

pml_write_files = function(x){
  n = length(x)
  for(i in 1:n){
    filename = paste0("problem_id_",i,".txt")
    write.table(x[i],file=filename,quote=FALSE,row.names=FALSE,col.names=FALSE)
  }
}

pml_write_files(predictions3)
```